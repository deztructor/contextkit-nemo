#!/usr/bin/make -f
# -*- makefile-mode -*-

#export DH_VERBOSE=1

# Sanitize build environment when running inside Scratchbox 1
ifneq (,$(wildcard /targets))
   export SBOX_REDIRECT_TO_DIRS=
   export PATH=/scratchbox/compilers/bin:/bin:/usr/bin:/scratchbox/tools/bin
endif

configure:
	./autogen.sh --no-configure

Makefile: configure
	./configure --prefix /usr --sysconfdir=/etc --disable-coverage

build: build-stamp
build-stamp: Makefile
	dh_testdir
	$(MAKE) all
	touch build-stamp

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp 
	[ -f Makefile ] && $(MAKE) distclean || true
	./autoclean.sh
	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs
	$(MAKE) DESTDIR=`pwd`/debian/tmp/ install

	# install testsets under /usr/share
	mkdir -p debian/tmp/usr/share

	# contextd-tests
	cp -f contextd/customer-tests/*.py debian/tmp/usr/share/contextd-tests
	chown -R root:root debian/tmp/usr/share/contextd-tests

	# libcontextsubscriberbluez-tests
	mkdir -p debian/tmp/usr/share/libcontextsubscriberbluez-tests/bluez-plugin

	cp -r libcontextsubscriber-plugins/customer-tests/common debian/tmp/usr/share/libcontextsubscriberbluez-tests
	cp libcontextsubscriber-plugins/customer-tests/bluez-plugin/*.py debian/tmp/usr/share/libcontextsubscriberbluez-tests/bluez-plugin
	cp libcontextsubscriber-plugins/customer-tests/bluez-plugin/tests.xml debian/tmp/usr/share/libcontextsubscriberbluez-tests/bluez-plugin
	chown -R root:root debian/tmp/usr/share/libcontextsubscriberbluez-tests

	# set the executable flag on to all files that have a shebang line
	grep -rl '^#!' debian/tmp/usr/share/contextd-tests | xargs chmod +x

	dh_install --sourcedir=`pwd`/debian/tmp/

	# introduce versioning to the bluez plugin name
	mv `pwd`/debian/libcontextsubscriberbluez/usr/lib/contextkit/subscriber-plugins/libbluez.so.0.0.0 `pwd`/debian/libcontextsubscriberbluez/usr/lib/contextkit/subscriber-plugins/bluez-1.so

binary-indep:
	# nothing to do

binary-arch: build install
	dh_testdir -a
	dh_testroot -a
	dh_installchangelogs -a
	dh_installdocs -a
	dh_installexamples -a
	dh_installmenu -a
	dh_installman -a
	dh_strip -p contextd --dbg-package="contextd-dbg"
	dh_strip -p libcontextsubscriberbluez --dbg-package="libcontextsubscriberbluez-dbg"
	dh_pycentral -pcontextd-tests
	dh_link -a
	dh_compress -a
	dh_fixperms -a
	dh_makeshlibs -a -V
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install
